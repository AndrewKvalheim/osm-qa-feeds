<!DOCTYPE html>
<html>
  <head>
    <title>osm qa feeds</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" lang="en"></meta>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
    <!--[if lte IE 8]><link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.3/leaflet.ie.css" /><![endif]-->
    <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <link type="text/css" href="http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css" rel="Stylesheet" />
    <script src="http://code.jquery.com/ui/1.10.0/jquery-ui.min.js"></script>
    <link href="libs/locationfilter.css" rel="stylesheet" />
    <script src="libs/locationfilter.js"></script>
    <style>
      body {
        max-width:40em;
        margin:auto;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }
      div#map {
        position:absolute;
        top:0;left:0;right:0;bottom:0;
      }
      div.box {
        background-color: rgba(255, 255, 255, 0.804);
        box-shadow: 0px 0px 3px 0px rgba(0, 0, 0, 0.804);
        border-radius:3px;
        padding:1em;
        margin-top:1em;
        opacity:0.99;
      }
      .hidden {
        display:none;
      }
      ul#list {
        padding-left:0;
      }
      #list li {
        display: inline-block;
        vertical-align: top;
        margin-bottom: 0.3em;
        padding-left: 1em;
        padding-right: 1em;
        width: 33%;
        box-sizing: border-box;
      }
      #list li h4 a {
        padding-left: 24px;
        background: url("libs/img/feed-icon-14x14.png") no-repeat 0 50%;
      }
      .ui-autocomplete {
        max-width: 32em;
      }
      .ui-widget {
        font-size:100%;
      }
      #searched {
        font-style:italic;
      }
      p,h3 {
        margin-top:0;
      }
      h4 {
        margin-bottom:0.3em;
      }
      a {
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div class="box">Get a list of <a href="http://openstreetmap.org"/>OpenStreetMap</a> quality assurance feeds for an area of your choice.</div>

    <div class="box" id="search-box">
      <p>Enter any place name (e.g. a city or region):</p>
      <input type="text" autofocus="autofocus" placeholder="city, region, etc." value="" id="search" style="width:16em;"><input type="button" value="search" onclick="$('input#search').autocomplete('search');"/>
    </div>
    <div class="box hidden" id="adjust-box">
      <p>Adjust bounding box (optional).</p>
      <input type="button" value="continue" id="adjusted"/>
    </div>
    <div class="box hidden" id="result-box">
      <h3>Your personal OSM quality assurance feeds for <span id="searched"></span>:</h3>
      <ul id="list">
      </ul>
      <input type="button" value="start over" id="again"/>
    </div>

    <script>
    // list of quality assurance tools:
    var qaTools = [
      {
        label: "OSM notes",
        note: "User generated bug reports from osm.org.",
        docUrl: "http://wiki.openstreetmap.org/wiki/Notes",
        feedUrl: "http://www.openstreetmap.org/api/0.6/notes/feed?bbox={lon1},{lat1},{lon2},{lat2}"
      },
      {
        label: "WhoDidIt",
        note: "Lists changesets that affect the watched region.",
        docUrl: "http://wiki.openstreetmap.org/wiki/Quality_assurance#WhoDidIt",
        feedUrl: "http://zverik.osm.rambler.ru/whodidit/scripts/rss.php?bbox={lon1},{lat1},{lon2},{lat2}"
      },
      {
        label: "newestosm",
        note: "Lists new contributors.",
        docUrl: "http://neis-one.org/2012/04/where-are-the-new-openstreetmap-contributors/",
        feedUrl: "http://resultmaps.neis-one.org/newestosmfeed.php?lon={lonc}&lat={latc}&deg={delta_deg}"
      },
      {
        label: "KeepRight!",
        note: "Reports a large variety of automatically detected errors.",
        docUrl: "http://wiki.openstreetmap.org/wiki/Keepright",
        feedUrl: "http://keepright.ipax.at/export.php?format=rss&ch=0,30,40,50,70,90,100,110,120,130,150,160,170,180,191,192,193,194,195,196,197,198,201,202,203,204,205,206,207,208,210,220,231,232,270,281,282,283,284,285,291,292,293,294,311,312,313,320,350,370,380,401,402,411,412,413&left={lon1}&bottom={lat1}&right={lon2}&top={lat2}"
      },
      {
        label: "OpenStreetBugs",
        note: "Like OSM-notes, but deprecated.",
        docUrl: "http://wiki.openstreetmap.org/wiki/OpenStreetBugs",
        feedUrl: "http://openstreetbugs.schokokeks.org/api/0.1/getRSSfeed?b={lon1}&t={lon2}&l={lat1}&r={lat2}"
      } 
      // add more qa tools here:
      /*{
        label: "<the name of the service>",
        note: "<a short description of what it does>",
        docUrl: "<an url to some documentation (displayed as a 'read more' link)>",
        feedUrl: "<the url to the actual rss/atom feed of the qa tool. see constructFeedUrl() for usable expansions>"
      }*/
    ];
    function constructFeedUrl(url,bbox) {
      /* this expands the following map coordinates in the feed urls:
       - {lat1},{lat2},{lon1},{lon2}: bounding box
       - {latc},{lonc}: the center of the bbox
       - {delta_deg}: max. width or height of the bbox in degrees (truncated to max. 1 deg)
      */
      var lon1 = Math.round(bbox.getWest()*10000000)/10000000;
      var lon2 = Math.round(bbox.getEast()*10000000)/10000000;
      var lat1 = Math.round(bbox.getSouth()*10000000)/10000000;
      var lat2 = Math.round(bbox.getNorth()*10000000)/10000000;
      var lonc = Math.round((lon1+lon2)/2*10000000)/10000000;
      var latc = Math.round((lat1+lat2)/2*10000000)/10000000;
      var delta_deg = Math.min(1, Math.round(Math.max(lat2-lat1,lon2-lon1)*100)/100);
      return url
        .replace("{lat1}", lat1)
        .replace("{lat2}", lat2)
        .replace("{lon1}", lon1)
        .replace("{lon2}", lon2)
        .replace("{latc}", latc)
        .replace("{lonc}", lonc)
        .replace("{delta_deg}", delta_deg)
      ;
    }
    $(function(e) {
      $("input#search").focus();
      var map = L.map('map', {
        zoomControl:false
      }).setView([0, 0], 2);
      L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://openstreetmap.org/license">ODbL</a>',
        maxZoom: 18
      }).addTo(map);
      var locationFilter = new L.LocationFilter({
        enable:false,
        adjustButton:false,
        enableButton:false
      }).addTo(map);
      function select_bbox(bb) {
        $("#search-box").hide();
        $("#adjust-box").slideDown();
        map.fitBounds(bb);
        locationFilter.setBounds(bb);
        locationFilter.enable();
        this.value="";
        return false;
      }
      function sanitize_bbox(bb) {
        bb = L.latLngBounds([bb[1],bb[3]],[bb[0],bb[2]]);
        var d = 0.001;
        if (Math.min(bb.getEast() - bb.getWest(), bb.getNorth() - bb.getSouth()) <= 2*d) {
          var center = bb.getCenter();
          return L.latLngBounds([center.lat-d,center.lng-d],[center.lat+d,center.lng+d]);
        } else {
          return bb;
        }
      }
      $("input#search").autocomplete({
      //on("submit", function() {
        source: function(request,response) {
          // show search string in result title
          $("#searched").text($("input#search")[0].value);
          // search it using nominatim
          $.ajax("http://nominatim.openstreetmap.org/search", {
            data: {
              format: "json",
              q: $("input#search")[0].value
            },
            dataType: "json"
          }).success(function(data) {
            if (data.length == 1) {
              select_bbox(sanitize_bbox(data[0].boundingbox));
            } else {
              response($.map(data,function(item) {
                return {
                  label: item.display_name,
                  value: item.display_name,
                  bbox: item.boundingbox
                }
              }));
            }
          }).error(function() {
            alert("nominatim error :(");
          });
        },
        minLength:2,
        select: function(event, ui) {
          select_bbox(sanitize_bbox(ui.item.bbox));
        }
      });
      $("input#search").autocomplete("option","delay",2000000000); // do not do this at all
      $("input#search").autocomplete().keypress(function(e) {
        if (e.which==13) $(this).autocomplete("search");
      });
      $("input#adjusted").on("click", function() {
        var bb = locationFilter.getBounds();
        locationFilter.disable();
        $("#adjust-box").hide();
        $("#result-box").slideDown();
        //print list of qa tools
        $("#list").empty();
        for (var i=0; i<qaTools.length; i++) {
          qaTool = qaTools[i];
          $("<li>"
            +"<h4><a href='"+constructFeedUrl(qaTool.feedUrl,bb)+"'>"+qaTool.label+"</a></h4>"
            +(qaTool.note||qaTool.docUrl?
              "<p>"
              +(qaTool.note||"")
              +(qaTool.docUrl ? "<br><a href='" + qaTool.docUrl + "'>read more</a>" : "")
              +"</p>":
              "")
            +"</li>")
          .appendTo("#list");
        }
      });
      $("input#again").on("click", function() {
        $("#result-box").hide();
        $("input#search")[0].value = "";
        $("#search-box").slideDown();
        $("input#search").focus();
      });
    });
    </script>
  </body>
</html>
